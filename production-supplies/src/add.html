<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Добавяне - Production Supplies</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="container">
<header class="header">
<h1>Добавяне на артикули</h1>
</header>

<nav class="nav-menu">
<button class="nav-button" onclick="location.href='admin.html'">Назад</button>
<div>
<button class="nav-button btn-primary" onclick="addNewRow()">Добави ред</button>
<button class="nav-button btn-success" onclick="saveAllItems()">Запази всички</button>
</div>
</nav>

<main class="main-content">
<table id="itemsTable">
<thead>
<tr>
<th>Код*</th>
<th>Име*</th>
<th>Позиция*</th>
<th>Брой/пакет*</th>
<th>Пакети*</th>
<th>Общо</th>
<th>Размер</th>
<th>Действие</th>
</tr>
</thead>
<tbody>
<tr>
<td><input type="text" class="item-code" required onblur="checkExistingItem(this)"></td>
<td><input type="text" class="item-name" required></td>
<td><input type="text" class="item-position" required></td>
<td><input type="number" class="items-per-package" required min="1" onchange="calculateRowTotal(this)"></td>
<td><input type="number" class="packages" required min="1" onchange="calculateRowTotal(this)"></td>
<td><input type="number" class="total" readonly></td>
<td>
<select class="item-size">
<option value="">-</option>
<option value="XS">XS</option>
<option value="S">S</option>
<option value="M">M</option>
<option value="L">L</option>
<option value="XL">XL</option>
<option value="XXL">XXL</option>
<option value="XXXL">XXXL</option>
</select>
</td>
<td><button class="remove-row-btn" onclick="removeRow(this)">Изтрий</button></td>
</tr>
</tbody>
</table>
</main>

<footer class="footer">
&copy; 2023 Production Supplies System
</footer>
</div>

<script type="module">
import { saveInventory, loadInventory } from './js/api.js';

if (localStorage.getItem('isAdmin') !== 'true') {
window.location.href = 'index.html';
}

function addNewRow() {
const tbody = document.querySelector('#itemsTable tbody');
const newRow = document.createElement('tr');
newRow.innerHTML = `
<td><input type="text" class="item-code" required onblur="checkExistingItem(this)"></td>
<td><input type="text" class="item-name" required></td>
<td><input type="text" class="item-position" required></td>
<td><input type="number" class="items-per-package" required min="1" onchange="calculateRowTotal(this)"></td>
<td><input type="number" class="packages" required min="1" onchange="calculateRowTotal(this)"></td>
<td><input type="number" class="total" readonly></td>
<td>
<select class="item-size">
<option value="">-</option>
<option value="XS">XS</option>
<option value="S">S</option>
<option value="M">M</option>
<option value="L">L</option>
<option value="XL">XL</option>
<option value="XXL">XXL</option>
<option value="XXXL">XXXL</option>
</select>
</td>
<td><button class="remove-row-btn" onclick="removeRow(this)">Изтрий</button></td>
`;
tbody.appendChild(newRow);
}

function removeRow(button) {
const row = button.closest('tr');
if (document.querySelectorAll('#itemsTable tbody tr').length > 1) {
row.remove();
} else {
alert('Трябва да има поне един ред!');
}
}

function calculateRowTotal(input) {
const row = input.closest('tr');
const itemsPerPackage = parseInt(row.querySelector('.items-per-package').value) || 0;
const packages = parseInt(row.querySelector('.packages').value) || 0;
row.querySelector('.total').value = itemsPerPackage * packages;
}

async function checkExistingItem(input) {
const code = input.value;
if (!code) return;

const items = await loadInventory();
const existingItem = items.find(item => item.code === code);

if (existingItem) {
const row = input.closest('tr');
row.querySelector('.item-name').value = existingItem.name;
row.querySelector('.item-position').value = existingItem.position;
row.querySelector('.items-per-package').value = existingItem.itemsPerPackage;
alert('Артикул с този код вече съществува! Новата наличност ще бъде добавена към текущата.');
}
}

async function saveAllItems() {
const rows = document.querySelectorAll('#itemsTable tbody tr');
let allValid = true;
const itemsToSave = [];
const archiveEntries = [];

rows.forEach(row => {
const code = row.querySelector('.item-code').value;
const name = row.querySelector('.item-name').value;
const position = row.querySelector('.item-position').value;
const itemsPerPackage = row.querySelector('.items-per-package').value;
const packages = row.querySelector('.packages').value;
const total = row.querySelector('.total').value;
const size = row.querySelector('.item-size').value;

if (!code || !name || !position || !itemsPerPackage || !packages) {
allValid = false;
row.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
} else {
itemsToSave.push({
code, name, position,
itemsPerPackage: parseInt(itemsPerPackage),
packages: parseInt(packages),
total: parseInt(total),
size: size || '',
dateAdded: new Date().toLocaleString()
});

archiveEntries.push({
action: itemsToSave.length > 1 ? 'Добавяне към наличност' : 'Добавяне на нов артикул',
user: 'admin',
date: new Date().toLocaleString(),
item: { code, name, position, size, total }
});
}
});

if (!allValid) {
alert('Моля попълнете всички задължителни полета (маркирани със *)!');
return;
}

try {
await saveInventory(itemsToSave, archiveEntries);
alert('Артикулите са запазени успешно!');
location.href = 'admin.html';
} catch (error) {
alert('Грешка при запазване: ' + error.message);
}
}
</script>
</body>
</html>